## 导读

上一章介绍了生成迁移脚本和迁移环境，使用的是 `alembic`。

但是upgrade函数是空的：
```python
def upgrade() -> None:
    pass
```

本章将介绍自动化生成迁移函数upgrade的内容。

#### 配置alembic/env.py

首先看下现在的目录结构：
```bash
.
├── alembic
│   ├── README
│   ├── __init__.py
│   ├── env.py
│   ├── script.py.mako
│   └── versions
│       └── d8222a383edb_add_user.py
├── alembic.ini
├── requirements.txt
├── sql_app
│   ├── __init__.py
│   ├── database.py
│   ├── main.py
│   └── user
│       ├── __init__.py
│       ├── crud.py
│       ├── models.py
│       └── schemas.py
```

这里在app项目目录之外执行命令初始化 `alembic`。
```bash
alembic init alembic
```

配置：`alembic/env.py`。

加入这一段代码：
```python
from sql_app.user.models import User

target_metadata = [
    User.metadata
]
```

执行迁移命令：
```bash
$ alembic revision --autogenerate -m "add user"
INFO  [alembic.runtime.migration] Context impl MySQLImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.autogenerate.compare] Detected added table 'users'
INFO  [alembic.autogenerate.compare] Detected added index 'ix_users_email' on '['email']'
INFO  [alembic.autogenerate.compare] Detected added index 'ix_users_id' on '['id']'
INFO  [alembic.autogenerate.compare] Detected added table 'items'
INFO  [alembic.autogenerate.compare] Detected added index 'ix_items_description' on '['description']'
INFO  [alembic.autogenerate.compare] Detected added index 'ix_items_id' on '['id']'
INFO  [alembic.autogenerate.compare] Detected added index 'ix_items_title' on '['title']'
Generating /**/**/**/alembic/versions/d8222a383edb_add_user.py ...  done

```

查看文件：`alembic/versions/d8222a383edb_add_user.py`:

```python
"""add user

Revision ID: d8222a383edb
Revises: 
Create Date: 2093-11-06 14:58:29.165377

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'd8222a383edb'
down_revision: Union[str, None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('users',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('email', sa.String(), nullable=True),
    sa.Column('hashed_password', sa.String(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_email'), 'users', ['email'], unique=True)
    op.create_index(op.f('ix_users_id'), 'users', ['id'], unique=False)
    op.create_table('items',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('title', sa.String(), nullable=True),
    sa.Column('description', sa.String(), nullable=True),
    sa.Column('owner_id', sa.Integer(), nullable=True),
    sa.ForeignKeyConstraint(['owner_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_items_description'), 'items', ['description'], unique=False)
    op.create_index(op.f('ix_items_id'), 'items', ['id'], unique=False)
    op.create_index(op.f('ix_items_title'), 'items', ['title'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_items_title'), table_name='items')
    op.drop_index(op.f('ix_items_id'), table_name='items')
    op.drop_index(op.f('ix_items_description'), table_name='items')
    op.drop_table('items')
    op.drop_index(op.f('ix_users_id'), table_name='users')
    op.drop_index(op.f('ix_users_email'), table_name='users')
    op.drop_table('users')
    # ### end Alembic commands ###

```

可以看到 `upgrade` 和 `downgrade` 都生成了升级和降级脚本

#### 执行迁移命令

```bash
$ alembic upgrade head
```

执行完报错：
```bash
sqlalchemy.exc.CompileError: (in table 'users', column 'email'): VARCHAR requires a length on dialect mysql

```
这个报错说 VARCHAR 类型需要指定长度。

添加长度：
```python
class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True, index=True)
    email = Column(String(128), unique=True, index=True)
    hashed_password = Column(String(256))
    is_active = Column(Boolean, default=True)

    items = relationship("Item", back_populates="owner")


class Item(Base):
    __tablename__ = "items"

    id = Column(Integer, primary_key=True, index=True)
    title = Column(String(128), index=True)
    description = Column(String(256), index=True)
    owner_id = Column(Integer, ForeignKey("users.id"))

    owner = relationship("User", back_populates="items")
```

再次执行：
```bash
$ alembic revision --autogenerate -m "add  length"
```

生成：
```python
# alembic/versions/fe3f3945eaf4_add_length.py
"""add  length

Revision ID: fe3f3945eaf4
Revises: 
Create Date: 2023-11-06 15:50:49.588264

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'fe3f3945eaf4'
down_revision: Union[str, None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('users',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('email', sa.String(length=128), nullable=True),
    sa.Column('hashed_password', sa.String(length=256), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_email'), 'users', ['email'], unique=True)
    op.create_index(op.f('ix_users_id'), 'users', ['id'], unique=False)
    op.create_table('items',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('title', sa.String(length=128), nullable=True),
    sa.Column('description', sa.String(length=256), nullable=True),
    sa.Column('owner_id', sa.Integer(), nullable=True),
    sa.ForeignKeyConstraint(['owner_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_items_description'), 'items', ['description'], unique=False)
    op.create_index(op.f('ix_items_id'), 'items', ['id'], unique=False)
    op.create_index(op.f('ix_items_title'), 'items', ['title'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_items_title'), table_name='items')
    op.drop_index(op.f('ix_items_id'), table_name='items')
    op.drop_index(op.f('ix_items_description'), table_name='items')
    op.drop_table('items')
    op.drop_index(op.f('ix_users_id'), table_name='users')
    op.drop_index(op.f('ix_users_email'), table_name='users')
    op.drop_table('users')
    # ### end Alembic commands ###

```

再次迁移：
```bash
$ alembic upgrade head                            
INFO  [alembic.runtime.migration] Context impl MySQLImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -> fe3f3945eaf4, add  length
```

查看数据库:
```bash
$ desc  items
id,int(11),NO,PRI,,auto_increment
title,varchar(128),YES,MUL,,""
description,varchar(256),YES,MUL,,""
owner_id,int(11),YES,MUL,,""

$ desc users
id,int(11),NO,PRI,,auto_increment
email,varchar(128),YES,UNI,,""
hashed_password,varchar(256),YES,"",,""
is_active,tinyint(1),YES,"",,""
```

需要注意的是：   
先执行：`alembic revision --autogenerate -m '******'`  

再执行：`alembic upgrade head`  

在执行升级过程中发生错误，需要删除未更新到数据库的前一个脚本

修改完后再次执行: `alembic revision --autogenerate` 


## 结语

至此，连接数据库，建立数据模型，迁移数据模型到数据库就完成了。

下一章将介绍输入数据的校验和数据的增删改查。


***

每日踩一坑，生活更轻松。

本期分享就到这里啦，祝君在测开之路上越走越顺，越走越远。

gzh：`测开工程师的烦恼`